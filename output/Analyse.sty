\RequirePackage{tools}

\newif\if@dvar\@dvarfalse
\DeclareOption{dvar}{\@dvartrue}
\newif\if@noanalysepar\@noanalyseparfalse
\DeclareOption{nopar}{\@noanalysepartrue}
\newif\if@analyselimits\@analyselimitsfalse
\DeclareOption{limits}{\@analyselimitstrue}
\newif\if@autoanalyselimits\@autoanalyselimitsfalse
\DeclareOption{autolimits}{\@autoanalyselimitstrue}
\newif\if@noanalysedisplay\@noanalysedisplayfalse
\DeclareOption{nodisplay}{\@noanalysedisplaytrue}
\DeclareOption*{}
\ProcessOptions\relax
\if@dvar
    \RequirePackage{pgffor}
\fi
\def\analyseleftp{\l}
\def\analyserightp{\r}
\if@noanalysepar
    \def\analyseleftp{}
    \def\analyserightp{}
\fi
\def\analyselimits{\nolimits}
\if@analyselimits
    \def\analyselimits{\limits}
\fi
\if@autoanalyselimits
    \def\analyselimits{}
\fi
\def\analysedisplay{\displaystyle}
\if@noanalysedisplay
    \def\analysedisplay{}
\fi

\if@notnofont
    \def\intkern@{\mkern-9mu\mathchoice{\mkern-6mu}{}{}{}}
\fi
\ifdefined\varotimes
    \ifdefined\oldotimes
    \else
        \let\oldotimes\otimes
        \let\otimes\varotimes
    \fi
\fi
\newcommand{\derfrac}[2]{{\analysedisplay\oldfrac{#1}{#2}}}

\newcommand{\toggleanalysepar}{\comparestring{\analyseleftp}{}{\def\analyseleftp{\l}\def\analyserightp{\r}}{\def\analyseleftp{}\def\analyserightp{}}}
\newcommand{\toggleanalyselimits}{\comparestring{\analyselimits}{\limits}{\def\analyselimits{\nolimits}}{\def\analyselimits{\limits}}}
\newcommand{\autoanalyselimits}{\def\analyselimits{}}
\newcommand{\toggleanalysedisplay}{\comparestring{\analysedisplay}{}{\def\analysedisplay{\displaystyle}}{\def\analysedisplay{}}}

\let\slantpartial\partial
\ifpdf
    % pdfLaTeX (flashcards)
    \newsavebox{\partialbox}
    \newcommand{\displaypartial}{\noexpand{\unslant{\displaystyle\textstyle\slantpartial}}\kern-1.2pt}
    \newcommand{\normalpartial}{\noexpand{\unslant{\textstyle\slantpartial}}\kern-1.2pt}
    \newcommand{\scriptpartial}{\noexpand{\unslant{\scriptstyle\slantpartial}}\kern-1.2pt}
    \newcommand{\scriptscriptpartial}{\noexpand{\unslant{\scriptscriptstyle\slantpartial}}\kern-1.2pt}
    \renewcommand{\partial}{\mathchoice{\displaypartial}{\normalpartial}{\scriptpartial}{\scriptscriptpartial}}
\else
    % LaTeX (htmlcards)
    \renewcommand{\partial}{\slantpartial\kern-0.8pt}
\fi
\newcommand{\resetpartial}{\let\partial\slantpartial}


\newcounter{mpdercount}
\def\mpderden{}
\newcounter{mpdervarcount}
\def\prevmpdervar{}
\newcounter{altintvarindex}
\def\altintspacevars{}
\def\altintvars{}
\if@dvar
    \newcommand{\scanmpderlist}[1]{
        \foreach \i in {#1}{
            \stepcounter{mpdercount}
            \comparestring{\prevmpdervar}{\i}{
                \stepcounter{mpdervarcount}
            }{
                \comparestring{\arabic{mpdervarcount}}{1}{}{\xdef\mpderden{\unexpanded\expandafter{\mpderden}^{\arabic{mpdervarcount}}}}
                \xdef\mpderden{\unexpanded\expandafter{\mpderden}\noexpand\partial\noexpand\i}
                \setcounter{mpdervarcount}{1}
                \xdef\prevmpdervar{\i}
            }
        }
        \comparestring{\arabic{mpdervarcount}}{1}{}{\edef\mpderden{\unexpanded\expandafter{\mpderden}^{\arabic{mpdervarcount}}}}
    }
    \newcommand{\scanmpder}[1]{
        \setcounter{mpdercount}{0}
        \def\mpderden{}
        \setcounter{mpdervarcount}{1}
        \def\prevmpdervar{}
        \scanmpderlist{#1}
    }
    \newcommand{\scanaltintlist}[1]{
        \foreach \i in {#1}{
            \comparestring{\arabic{altintvarindex}}{0}{\xdef\altintspacevars{\unexpanded\expandafter{\altintspacevars}\noexpand\intd\noexpand#1}}{\ifx#1\cdots\relax\xdef\altintspacevars{\unexpanded\expandafter{\altintspacevars}\noexpand#1}\else\xdef\altintspacevars{\unexpanded\expandafter{\altintspacevars}\noexpand\dd\noexpand#1}\fi}
            \xdef\altintvars{\unexpanded\expandafter{\altintvars}\noexpand\dd\noexpand#1}
            \setcounter{altintvarindex}{1}
        }
    }
    \newcommand{\scanaltint}[1]{
        \setcounter{altintvarindex}{0}
        \def\altintspacevars{}
        \def\altintvars{}
        \scanaltintlist{#1}
    }
\else
    \def\do@scanmpder#1,{%
        \ifx#1\relax
            \let\next\relax
        \else
            \stepcounter{mpdercount}
            \comparestring{\prevmpdervar}{#1}{
                \stepcounter{mpdervarcount}
            }{
                \comparestring{\arabic{mpdervarcount}}{1}{}{\edef\mpderden{\unexpanded\expandafter{\mpderden}^{\arabic{mpdervarcount}}}}
                \edef\mpderden{\unexpanded\expandafter{\mpderden}\noexpand\partial\noexpand#1}
                \setcounter{mpdervarcount}{1}
                \def\prevmpdervar{#1}
            }
            \let\next\do@scanmpder
        \fi\next
    }
    \newcommand{\scanmpder}[1]{
        \setcounter{mpdercount}{0}
        \def\mpderden{}
        \setcounter{mpdervarcount}{1}
        \def\prevmpdervar{}
        \do@scanmpder#1,\relax,
        \comparestring{\arabic{mpdervarcount}}{1}{}{\edef\mpderden{\unexpanded\expandafter{\mpderden}^{\arabic{mpdervarcount}}}}
    }
    \def\do@scanaltint#1,{%
        \ifx#1\relax
            \let\next\relax
        \else
            \comparestring{\arabic{altintvarindex}}{0}{\edef\altintspacevars{\unexpanded\expandafter{\altintspacevars}\noexpand\intd\noexpand#1}}{\ifx#1\cdots\relax\edef\altintspacevars{\unexpanded\expandafter{\altintspacevars}\noexpand#1}\else\edef\altintspacevars{\unexpanded\expandafter{\altintspacevars}\noexpand\dd\noexpand#1}\fi}
            \edef\altintvars{\unexpanded\expandafter{\altintvars}\noexpand\dd\noexpand#1}
            \setcounter{altintvarindex}{1}
            \let\next\do@scanaltint
        \fi\next
    }
    \newcommand{\scanaltint}[1]{
        \if\relax\detokenize{#1}\relax
            \setcounter{altintvarindex}{0}
            \def\altintspacevars{}
            \def\altintvars{}
        \else
            \setcounter{altintvarindex}{0}
            \def\altintspacevars{}
            \def\altintvars{}
            \do@scanaltint#1,\relax,
        \fi
    }
\fi

\DeclareMathOperator{\oldd}{d}
\newcommand{\dd}{{\oldd}}
\newcommand{\intd}{{{}\oldd}}
\newcommand{\der}[1][]{\def\derargI{#1}\tmpder}
\newcommand{\tmpder}[3][x]{
    \if\relax\detokenize{#3}\relax
        \def\derargIII{}
    \else
        \def\derargIII{\analyseleftp{#3}\analyserightp}
    \fi\derfrac{\dd^{\derargI}{#2}}{\dd#1^{\derargI}}\derargIII}
\newcommand{\pder}[1][]{\def\pderargI{#1}\tmppder}
\newcommand{\tmppder}[3][x]{
    \if\relax\detokenize{#3}\relax
        \def\pderargIII{}
    \else
        \def\pderargIII{\analyseleftp{#3}\analyserightp}
    \fi\derfrac{\partial^{\pderargI}{#2}}{\partial#1^{\pderargI}}\pderargIII}
\newcommand{\mpder}[3][x]{\scanmpder{#1}
    \if\relax\detokenize{#3}\relax
        \def\mpderargIII{}
    \else
        \def\mpderargIII{\analyseleftp{#3}\analyserightp}
    \fi\derfrac{\partial^{\arabic{mpdercount}}{#2}}{\mpderden}\mpderargIII}
\let\oldint\int
\newcommand{\inint}{\mkern-3mu{\analysedisplay\mathchoice{\mkern-4mu}{\mkern-2mu}{}{}}\int}
\renewcommand{\int}[1][]{\def\intvar{#1}
    \if\relax\detokenize{#1}\relax
        \def\intargI{}
    \else
        \def\intargI{{{}\oldd}#1}
    \fi\tmpint
}
\newcommand{\tmpint}[1][]{
    \if\relax\detokenize{#1}\relax
        \def\intargII{}
    \else
        \def\intargII{\analyselimits_{#1}}
    \fi\tmptmpint
}
\newcommand{\tmptmpint}[1][]{
    \if\relax\detokenize{#1}\relax
        \def\intargIII{}
    \else
        \def\intargIII{\analyselimits^#1}
    \fi\tmptmptmpint
}
\newcommand{\tmptmptmpint}[2][]{\mathop{}\mkern-3mu{\analysedisplay\oldint\intargII\intargIII}\mkern-3mu{}\mathop{}\analyseleftp{#2}\analyserightp\if\relax\detokenize{#1}\relax\intargI\else{{}\mathop{#1\l\dd\intvar\r}}\fi}
\newcommand{\altint}[1]{\def\altintsymb{#1}\tmpaltint}
\newcommand{\tmpaltint}[1][]{\scanaltint{#1}\tmptmpaltint}
\newcommand{\tmptmpaltint}[1][]{
    \if\relax\detokenize{#1}\relax
        \def\intargII{}
    \else
        \def\intargII{\analyselimits_{#1}}
    \fi\tmptmptmpaltint
}
\newcommand{\tmptmptmpaltint}[1][]{
    \if\relax\detokenize{#1}\relax
        \def\intargIII{}
    \else
        \def\intargIII{\analyselimits^#1}
    \fi\tmptmptmptmpaltint
}
\newcommand{\tmptmptmptmpaltint}[2][]{\mathop{}\mkern-3mu{\analysedisplay\altintsymb\intargII\intargIII}\mkern-3mu{}\mathop{}\analyseleftp{#2}\analyserightp\if\relax\detokenize{#1}\relax\altintspacevars\else{{}\mathop{{\let\oldotimes\otimes\def\otimes{{\oldotimes}}#1}\l\altintvars\r}}\fi}
\newcommand{\eval}[1][]{\def\evalargI{#1}\tmpeval}
\newcommand{\tmpeval}[2][]{\left[#2\right]_{\evalargI}^{#1}}
\@ifundefined{oldsum}{\let\oldsum\sum}{}
\newcommand{\serie}[1]{\oldsum#1}
\DeclareMathOperator{\oldesc}{Esc}
\newcommand{\esc}[2][]{\oldesc_{#1}\l#2\r}
\DeclareMathOperator{\oldcm}{CM}
\newcommand{\cm}[2][]{\oldcm_{#1}\l#2\r}
\DeclareMathOperator{\oldfnint}{Int}
\newcommand{\fnint}[1]{\oldfnint\l#1\r}
\let\anrm\relax
\newcommand{\anrm}[2][\infty]{\left\|#2\right\|_{#1}}
\DeclareMathOperator{\oldva}{VA}
\newcommand{\va}[1]{\oldva\l#1\r}
\DeclareMathOperator{\oldepi}{Epi}
\newcommand{\epi}[1]{\oldepi\l#1\r}
\let\oldid\relax
\let\id\relax
\DeclareMathOperator{\oldid}{id}
\newcommand{\id}{\oldid}
\let\appl\relax
\newcommand{\appl}[5]{\begin{array}[t]{@{}r@{}r@{}c@{}l@{}}#1\!:\!{}&#2&{}\longrightarrow{}&#3\\&#4&{}\longmapsto{}&#5\end{array}}
\let\nappl\relax
\newcommand{\nappl}[4]{\begin{array}[t]{@{}r@{}c@{}l@{}}#1&{}\longrightarrow{}&#2\\#3&{}\longmapsto{}&#4\end{array}}